<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plantilla de Rúbrica</title>
    <style>
        :root {
            --primary: #3498db;
            --secondary: #2c3e50;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --light: #ecf0f1;
            --dark: #34495e;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(135deg, var(--secondary), var(--primary));
            color: white;
            padding: 25px;
            text-align: center;
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .main-content {
            display: flex;
            flex-wrap: wrap;
            padding: 20px;
        }
        
        .form-section {
            flex: 1;
            min-width: 300px;
            padding: 20px;
            border-right: 1px solid #eee;
        }
        
        .preview-section {
            flex: 2;
            min-width: 500px;
            padding: 20px;
        }
        
        .section-title {
            color: var(--secondary);
            border-bottom: 2px solid var(--primary);
            padding-bottom: 10px;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
        }
        
        input, textarea, select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        
        input:focus, textarea:focus, select:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }
        
        .btn {
            display: inline-block;
            padding: 12px 25px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s;
            text-align: center;
            text-decoration: none; /* For potential <a> usage */
        }
        
        .btn:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .btn-success {
            background-color: var(--success);
        }
        
        .btn-success:hover {
            background-color: #219653;
        }
        
        .btn-warning {
            background-color: var(--warning);
        }
        
        .btn-warning:hover {
            background-color: #e67e22;
        }
        
        .btn-danger {
            background-color: var(--danger);
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 20px;
        }
        
        .item-list {
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 5px;
            padding: 10px;
        }
        
        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .list-item:last-child {
            border-bottom: none;
        }
        
        .rubric-preview {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }
        
        .rubric-header {
            background-color: var(--secondary);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .rubric-title {
            font-size: 1.8rem;
            margin-bottom: 10px;
        }
        
        .rubric-info {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-around;
            margin-top: 15px;
            font-size: 0.9rem;
        }
        
        .info-item {
            margin: 5px 15px;
        }
        
        .rubric-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .rubric-table th {
            background-color: var(--primary);
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: 600;
        }
        
        .rubric-table td {
            padding: 12px;
            border: 1px solid #ddd;
            text-align: center;
            vertical-align: top; /* Align descriptor text to top */
        }
        
        .rubric-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .rubric-table tr:hover {
            background-color: #f1f9ff;
        }
        
        .criterion-cell {
            text-align: left;
            font-weight: 600;
            background-color: #e3f2fd;
        }
        
        .descriptor-cell {
            text-align: left;
            min-width: 150px;
        }
        
        .observations {
            margin-top: 30px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }
        
        .observations h3 {
            color: var(--secondary);
            margin-bottom: 15px;
        }
        
        .observations textarea {
            min-height: 120px;
        }
        
        .export-section {
            text-align: center;
            padding: 30px;
            background-color: #f8f9fa;
            border-top: 1px solid #eee;
        }
        
        .export-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .export-btn {
            padding: 15px 30px;
            font-size: 1.1rem;
        }
        
        .descriptor-input {
            width: 100%;
            min-height: 80px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: inherit;
            resize: vertical;
        }
        
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            .form-section {
                border-right: none;
                border-bottom: 1px solid #eee;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Plantilla de rúbrica</h1>
            <p class="subtitle">Cree una plantilla para generar rúbricas de evaluación</p>
        </header>
        
        <div class="main-content">
            <div class="form-section">
                <h2 class="section-title">Información de la plantilla</h2>
                
                <div class="form-group">
                    <label for="teacher-name">Nombre del docente:</label>
                    <input type="text" id="teacher-name" placeholder="Ingrese su nombre">
                </div>
                
                <div class="form-group">
                    <label for="subject">Materia:</label>
                    <input type="text" id="subject" placeholder="Nombre de la materia">
                </div>
                
                <div class="form-group">
                    <label for="work">Trabajo a evaluar:</label>
                    <input type="text" id="work" placeholder="Nombre del trabajo o actividad">
                </div>
                
                <h2 class="section-title">Niveles de desempeño</h2>
                
                <div class="form-group">
                    <label for="level-name">Nombre del nivel:</label>
                    <input type="text" id="level-name" placeholder="Ej: Excelente, Bueno, Regular...">
                </div>
                
                <div class="form-group">
                    <label for="level-value">Valor relativo (puntos):</label>
                    <input type="number" id="level-value" min="0" value="0" placeholder="Ej: 4 (para Excelente), 3, 2, 1...">
                </div>
                
                <button id="add-level" class="btn">Agregar nivel</button>
                
                <div class="item-list" id="levels-list">
                    <!-- Niveles se agregarán aquí -->
                </div>
                
                <h2 class="section-title">Criterios de evaluación</h2>
                
                <div class="form-group">
                    <label for="criterion-name">Nombre del criterio:</label>
                    <input type="text" id="criterion-name" placeholder="Ej: Claridad, Ortografía, Creatividad...">
                </div>
                
                <div class="form-group">
                    <label for="criterion-max-points">Puntaje máximo del criterio:</label>
                    <input type="number" id="criterion-max-points" min="0" value="0" placeholder="Ej: 20, 15, 10...">
                </div>
                
                <button id="add-criterion" class="btn">Agregar criterio</button>
                
                <div class="item-list" id="criteria-list">
                    <!-- Criterios se agregarán aquí -->
                </div>
                
                <div class="btn-group">
                    <button id="generate-btn" class="btn btn-success">Generar vista previa</button>
                    <button id="reset-btn" class="btn btn-danger">Reiniciar</button>
                </div>
            </div>
            
            <div class="preview-section">
                <h2 class="section-title">Vista previa de la plantilla</h2>
                
                <div class="rubric-preview" id="rubric-preview">
                    <div class="rubric-header">
                        <h2 class="rubric-title">Plantilla de rúbrica</h2>
                        <div class="rubric-info">
                            <div class="info-item"><strong>Docente:</strong> <span id="preview-teacher">-</span></div>
                            <div class="info-item"><strong>Materia:</strong> <span id="preview-subject">-</span></div>
                            <div class="info-item"><strong>Trabajo:</strong> <span id="preview-work">-</span></div>
                        </div>
                    </div>
                    
                    <table class="rubric-table" id="rubric-table">
                        <thead>
                            <tr>
                                <th>Criterios</th>
                                <!-- Niveles se insertarán aquí -->
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Criterios se insertarán aquí -->
                        </tbody>
                    </table>
                    
                    <div class="observations">
                        <h3>Observaciones generales de la rúbrica</h3>
                        <textarea id="observations" placeholder="Instrucciones generales para el uso de la rúbrica..."></textarea>
                    </div>
                </div>
                
                <div class="export-section">
                    <h2 class="section-title">Exportar plantilla</h2>
                    <div class="export-buttons">
                        <button id="export-html" class="btn export-btn">Exportar a HTML (interactiva)</button>
                        <button id="export-pdf" class="btn export-btn btn-warning">Exportar a PDF (imprimible)</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let levels = []; // Each level: {name, id, relativeValue}
        let criteria = []; // Each criterion: {name, id, maxPoints}
        let descriptors = {}; // { "criterionId-levelId": "descriptor text" }
        
        // Elementos del DOM
        const teacherNameInput = document.getElementById('teacher-name');
        const subjectInput = document.getElementById('subject');
        const workInput = document.getElementById('work');
        const levelNameInput = document.getElementById('level-name');
        const levelValueInput = document.getElementById('level-value');
        const criterionNameInput = document.getElementById('criterion-name');
        const criterionMaxPointsInput = document.getElementById('criterion-max-points');
        const levelsList = document.getElementById('levels-list');
        const criteriaList = document.getElementById('criteria-list');
        const rubricTable = document.getElementById('rubric-table');
        const observationsInput = document.getElementById('observations');
        
        // --- Funciones para Niveles y Criterios ---
        
        // Agregar nivel
        function addLevel(name, relativeValueStr) {
            if (!name.trim()) {
                alert("Por favor ingrese un nombre para el nivel.");
                return;
            }
            const parsedValue = parseInt(relativeValueStr);
            if (relativeValueStr.trim() === "" || isNaN(parsedValue) || parsedValue < 0) {
                alert("Por favor ingrese un valor relativo numérico y no negativo para el nivel.");
                return;
            }
            const level = {name: name.trim(), id: Date.now(), relativeValue: parsedValue};
            levels.push(level);
            renderLevelsList();
            levelNameInput.value = "";
            levelValueInput.value = "0"; 
            generateTemplate(); // Regenerar vista previa
        }
        
        // Agregar criterio
        function addCriterion(name, maxPointsStr) {
            if (!name.trim()) {
                alert("Por favor ingrese un nombre para el criterio.");
                return;
            }
            const parsedMaxPoints = parseInt(maxPointsStr);
            if (maxPointsStr.trim() === "" || isNaN(parsedMaxPoints) || parsedMaxPoints < 0) {
                alert("Por favor ingrese un puntaje máximo numérico y no negativo para el criterio.");
                return;
            }
            const criterion = {name: name.trim(), id: Date.now(), maxPoints: parsedMaxPoints};
            criteria.push(criterion);
            renderCriteriaList();
            criterionNameInput.value = "";
            criterionMaxPointsInput.value = "0"; 
            generateTemplate(); // Regenerar vista previa
        }
        
        // Renderizar lista de niveles
        function renderLevelsList() {
            levelsList.innerHTML = "";
            levels.forEach((level, index) => {
                const item = document.createElement('div');
                item.className = 'list-item';
                item.innerHTML = `
                    <span>${level.name} (${level.relativeValue} pts)</span>
                    <button class="btn btn-danger btn-sm" onclick="removeLevel(${index})">Eliminar</button>
                `;
                levelsList.appendChild(item);
            });
        }
        
        // Renderizar lista de criterios
        function renderCriteriaList() {
            criteriaList.innerHTML = "";
            criteria.forEach((criterion, index) => {
                const item = document.createElement('div');
                item.className = 'list-item';
                item.innerHTML = `
                    <span>${criterion.name} (Máx: ${criterion.maxPoints} pts)</span>
                    <button class="btn btn-danger btn-sm" onclick="removeCriterion(${index})">Eliminar</button>
                `;
                criteriaList.appendChild(item);
            });
        }
        
        // Eliminar nivel
        function removeLevel(index) {
            levels.splice(index, 1);
            // También limpiar descriptores asociados a este nivel
            // Hay que asegurar que el ID se obtenga antes de eliminarlo del array.
            // Una forma más robusta sería pasar el id directamente o re-filtrar descriptors.
            // Por ahora, asumimos que al eliminar un nivel, los descriptores se manejarán en la siguiente generación
            // o se limpiarán si se vuelve a cargar la página, lo que para una herramienta de generación es aceptable.
            // Para una gestión más estricta, se debería iterar sobre `levels` y `criteria` para reconstruir `descriptors`.
            const removedLevelId = levels[index] ? levels[index].id : null; 
            for (const key in descriptors) {
                if (key.endsWith(`-${removedLevelId}`)) {
                    delete descriptors[key];
                }
            }
            renderLevelsList();
            generateTemplate();
        }
        
        // Eliminar criterio
        function removeCriterion(index) {
            const removedCriterionId = criteria[index] ? criteria[index].id : null; 
            criteria.splice(index, 1);
            // Limpiar descriptores asociados a este criterio
            for (const key in descriptors) {
                if (key.startsWith(`${removedCriterionId}-`)) {
                    delete descriptors[key];
                }
            }
            renderCriteriaList();
            generateTemplate();
        }
        
        // --- Generar Vista Previa de la Rúbrica ---
        
        function generateTemplate() {
            // Actualizar información del encabezado
            document.getElementById('preview-teacher').textContent = teacherNameInput.value || "-";
            document.getElementById('preview-subject').textContent = subjectInput.value || "-";
            document.getElementById('preview-work').textContent = workInput.value || "-";
            
            // Limpiar tabla
            const thead = rubricTable.querySelector('thead tr');
            const tbody = rubricTable.querySelector('tbody');
            
            // Mantener la primera celda (Criterios)
            thead.innerHTML = '<th>Criterios</th>';
            
            // Agregar niveles al encabezado con su valor relativo
            levels.forEach(level => {
                const th = document.createElement('th');
                th.innerHTML = `${level.name}<br>(${level.relativeValue} pts)`;
                thead.appendChild(th);
            });
            
            // Agregar criterios al cuerpo
            tbody.innerHTML = '';
            criteria.forEach((criterion) => {
                const row = document.createElement('tr');
                
                // Celda del criterio con su puntaje máximo
                const criterionCell = document.createElement('td');
                criterionCell.className = 'criterion-cell';
                criterionCell.innerHTML = `${criterion.name}<br>(Máx: ${criterion.maxPoints} pts)`;
                row.appendChild(criterionCell);
                
                // Celdas de niveles con descriptores editables
                levels.forEach((level) => {
                    const cell = document.createElement('td');
                    cell.className = 'descriptor-cell';
                    
                    const textarea = document.createElement('textarea');
                    textarea.className = 'descriptor-input';
                    textarea.placeholder = `Descriptor para "${level.name}"`;
                    textarea.dataset.criterionId = criterion.id;
                    textarea.dataset.levelId = level.id;
                    
                    // Recuperar descriptor guardado si existe
                    const key = `${criterion.id}-${level.id}`;
                    if (descriptors[key]) {
                        textarea.value = descriptors[key];
                    }
                    
                    // Guardar cambios en descriptores
                    textarea.addEventListener('input', function() {
                        descriptors[key] = this.value;
                    });
                    
                    cell.appendChild(textarea);
                    row.appendChild(cell);
                });
                
                tbody.appendChild(row);
            });
        }
        
        // --- Exportar a HTML (Plantilla Interactiva de Evaluación) ---
        function exportToHTML() {
            const teacher = teacherNameInput.value || "Docente";
            const subject = subjectInput.value || "Materia";
            const work = workInput.value || "Trabajo";
            const observations = observationsInput.value || "";
            
            const maxOverallLevelValue = levels.reduce((max, level) => Math.max(max, level.relativeValue), 0);
            let totalMaxPossibleScore = 0;
            criteria.forEach(c => totalMaxPossibleScore += c.maxPoints);

            let htmlContent = `<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rúbrica de evaluación - ${work}</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #f5f7fa; }
        .container { max-width: 1000px; margin: 0 auto; background: white; border-radius: 10px; box-shadow: 0 0 20px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: linear-gradient(135deg, #2c3e50, #3498db); color: white; padding: 25px; text-align: center; }
        .header h1 { font-size: 2rem; margin-bottom: 10px; }
        .info { display: flex; flex-wrap: wrap; justify-content: space-around; margin-top: 15px; font-size: 0.9rem; }
        .info-item { margin: 5px 15px; }
        .rubric-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        .rubric-table th { background-color: #3498db; color: white; padding: 15px; text-align: center; font-weight: 600; }
        .rubric-table td { padding: 12px; border: 1px solid #ddd; text-align: center; vertical-align: top; }
        .rubric-table tr:nth-child(even) { background-color: #f9f9f9; }
        .criterion-cell { text-align: left; font-weight: 600; background-color: #e3f2fd; }
        .descriptor-cell { text-align: left; min-width: 150px; }
        .observations { margin: 30px 20px; padding: 20px; background-color: #f8f9fa; border-radius: 8px; }
        .observations h3 { color: #2c3e50; margin-bottom: 15px; }
        .student-info { margin: 20px; padding: 15px; background-color: #e3f2fd; border-radius: 8px; }
        .student-info label { display: block; margin-bottom: 5px; font-weight: bold; }
        .student-info input, .student-info textarea { width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px; }
        .signature { margin: 30px 20px; display: flex; justify-content: space-between; }
        .signature div { text-align: center; width: 45%; }
        .signature-line { margin-top: 50px; border-top: 1px solid #333; padding-top: 10px; }
        .score-info-cell { 
            display: flex; 
            flex-direction: column; 
            align-items: flex-start; 
            padding: 5px 0; 
            text-align: left;
        }
        .score-info-cell input[type="radio"] { margin-right: 5px; cursor: pointer; }
        .score-info-cell label { display: flex; align-items: flex-start; font-weight: normal; margin-bottom: 5px; cursor: pointer; }
        .score-value { font-weight: bold; color: #27ae60; margin-left: auto; }
        .total-score-summary {
            margin: 30px 20px;
            padding: 20px;
            background-color: #e3f2fd;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: bold;
        }
        .total-score-summary p { margin: 5px 0; }

        @media print {
            body { background-color: white; }
            .container { box-shadow: none; }
            .print-button { display: none; }
            .rubric-table tr { page-break-inside: avoid; }
            textarea#eval-observations { border: none; background: transparent; resize: none; overflow: hidden; height: auto; } /* For printing */
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Rúbrica de evaluación</h1>
            <div class="info">
                <div class="info-item"><strong>Docente:</strong> ${teacher}</div>
                <div class="info-item"><strong>Materia:</strong> ${subject}</div>
                <div class="info-item"><strong>Trabajo:</strong> ${work}</div>
            </div>
        </div>
        
        <div class="student-info">
            <label for="student-name">Nombre del estudiante:</label>
            <input type="text" id="student-name" placeholder="Nombre completo del estudiante">
            
            <label for="date">Fecha:</label>
            <input type="date" id="date">
        </div>
        
        <table class="rubric-table">
            <thead>
                <tr>
                    <th>Criterios</th>
`;

            levels.forEach(level => {
                htmlContent += `                    <th>${level.name} (${level.relativeValue} pts)</th>\n`;
            });

            htmlContent += `                </tr>
            </thead>
            <tbody>
`;

            criteria.forEach(criterion => {
                htmlContent += `                <tr data-criterion-id="${criterion.id}" data-criterion-max-points="${criterion.maxPoints}">
                    <td class="criterion-cell">${criterion.name}<br>(Máx: ${criterion.maxPoints} pts)</td>\n`;
                
                levels.forEach(level => {
                    const key = `${criterion.id}-${level.id}`;
                    const descriptor = descriptors[key] || "";
                    // Calculate score for this specific level and criterion
                    const calculatedScore = maxOverallLevelValue > 0 ? ((level.relativeValue / maxOverallLevelValue) * criterion.maxPoints).toFixed(1) : 0;
                    
                    htmlContent += `                    <td class="descriptor-cell">
                        <div class="score-info-cell">
                            <label>
                                <input type="radio" name="criterion_${criterion.id}" value="${level.id}" 
                                    data-criterion-id="${criterion.id}" 
                                    data-level-id="${level.id}"
                                    data-relative-value="${level.relativeValue}"
                                    data-calculated-score="${calculatedScore}"
                                    onchange="calculateTotalScores()">
                                <span>
                                    ${descriptor}
                                    <span class="score-value">(${calculatedScore} pts)</span>
                                </span>
                            </label>
                        </div>
                    </td>\n`;
                });
                
                htmlContent += `                </tr>\n`;
            });

            htmlContent += `            </tbody>
        </table>
        
        <div class="observations">
            <h3>Observaciones específicas de la evaluación</h3>
            <textarea id="eval-observations" placeholder="Escriba aquí las observaciones detalladas para el estudiante..." style="width: 100%; min-height: 100px; padding: 10px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
            <h3>Observaciones generales de la rúbrica</h3>
            <p>${observations.replace(/\n/g, '<br>')}</p>
        </div>
        
        <div class="total-score-summary">
            <p><strong>Puntaje total alcanzado:</strong> <span id="actual-total-score">0.0</span> / <span id="max-total-possible-score">${totalMaxPossibleScore}</span> pts</p>
            <p><strong>Puntaje normalizado (sobre 100):</strong> <span id="normalized-final-score">0.0</span></p>
        </div>

        <div style="text-align: center; margin-top: 20px;">
            <button class="btn print-button" onclick="window.print()">Imprimir / Guardar como PDF</button>
        </div>
        
        <div class="signature">
            <div>
                <div class="signature-line">Firma del docente</div>
            </div>
            <div>
                <div class="signature-line">Firma del estudiante</div>
            </div>
        </div>
    </div>
    
    <script>
        document.getElementById('date').valueAsDate = new Date();

        // These variables are embedded into the exported HTML, so they are static copies at export time.
        const totalMaxPossibleScore = ${totalMaxPossibleScore}; 

        function calculateTotalScores() {
            let actualTotalScore = 0;
            // Iterate over all checked radio buttons to sum their calculated scores
            const checkedRadios = document.querySelectorAll('input[type="radio"][name^="criterion_"]:checked');
            
            checkedRadios.forEach(radio => {
                actualTotalScore += parseFloat(radio.dataset.calculatedScore);
            });

            document.getElementById('actual-total-score').textContent = actualTotalScore.toFixed(1);
            
            let normalizedScore = 0;
            if (totalMaxPossibleScore > 0) {
                normalizedScore = (actualTotalScore / totalMaxPossibleScore) * 100;
            }
            document.getElementById('normalized-final-score').textContent = normalizedScore.toFixed(1);
        }

        // Call once on load to initialize scores (if any radios are pre-checked, though unlikely for a new template)
        calculateTotalScores();
    <\/script>
</body>
</html>`;

            // Crear y descargar archivo
            const blob = new Blob([htmlContent], {type: 'text/html'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `rubrica_interactiva_${work.replace(/ /g, '_')}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // --- Exportar a PDF (Vista Imprimible Estática) ---
        function exportToPDF() {
            const teacher = teacherNameInput.value || "Docente";
            const subject = subjectInput.value || "Materia";
            const work = workInput.value || "Trabajo";
            const observations = observationsInput.value || "";

            const maxOverallLevelValue = levels.reduce((max, level) => Math.max(max, level.relativeValue), 0);
            let totalMaxPossibleScore = 0;
            criteria.forEach(c => totalMaxPossibleScore += c.maxPoints);

            let pdfContent = `<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rúbrica de evaluación</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #fff; }
        .container { max-width: 1000px; margin: 0 auto; background: white; border-radius: 10px; box-shadow: 0 0 20px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: linear-gradient(135deg, #2c3e50, #3498db); color: white; padding: 25px; text-align: center; }
        .header h1 { font-size: 2rem; margin-bottom: 10px; }
        .info { display: flex; flex-wrap: wrap; justify-content: space-around; margin-top: 15px; font-size: 0.9rem; }
        .info-item { margin: 5px 15px; }
        .rubric-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        .rubric-table th { background-color: #3498db; color: white; padding: 15px; text-align: center; font-weight: 600; }
        .rubric-table td { padding: 12px; border: 1px solid #ddd; text-align: center; vertical-align: top; }
        .rubric-table tr:nth-child(even) { background-color: #f9f9f9; }
        .criterion-cell { text-align: left; font-weight: 600; background-color: #e3f2fd; }
        .descriptor-cell { text-align: left; min-width: 150px; }
        .observations { margin: 30px 20px; padding: 20px; background-color: #f8f9fa; border-radius: 8px; }
        .observations h3 { color: #2c3e50; margin-bottom: 15px; }
        .student-info { margin: 20px; padding: 15px; background-color: #e3f2fd; border-radius: 8px; }
        .student-info label { display: block; margin-bottom: 5px; font-weight: bold; }
        .student-info input { width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px; }
        .signature { margin: 30px 20px; display: flex; justify-content: space-between; }
        .signature div { text-align: center; width: 45%; }
        .signature-line { margin-top: 50px; border-top: 1px solid #333; padding-top: 10px; }
        .score-value { font-weight: bold; color: #27ae60; }
        /* Hide interactive elements for print */
        input[type="radio"] { display: none; }
        .total-score-summary {
            margin: 30px 20px;
            padding: 20px;
            background-color: #e3f2fd;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: bold;
        }
        .total-score-summary p { margin: 5px 0; }
        /* Style for blank lines to fill in scores manually */
        .blank-line { border-bottom: 1px dashed #333; display: inline-block; width: 80px; margin: 0 5px; }

        @media print {
            body { box-shadow: none; }
            .container { box-shadow: none; }
            .rubric-table tr { page-break-inside: avoid; }
            input[type="date"] { background-color: white; border: none; } /* Ensure date input looks good */
            textarea { border: none; background: transparent; resize: none; overflow: hidden; height: auto; } /* Make observations print friendly */
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Rúbrica de evaluación</h1>
            <div class="info">
                <div class="info-item"><strong>Docente:</strong> ${teacher}</div>
                <div class="info-item"><strong>Materia:</strong> ${subject}</div>
                <div class="info-item"><strong>Trabajo:</strong> ${work}</div>
            </div>
        </div>
        
        <div class="student-info">
            <label for="student-name">Nombre del estudiante:</label>
            <input type="text" id="student-name" placeholder="Nombre completo del estudiante">
            
            <label for="date">Fecha:</label>
            <input type="date" id="date">
        </div>
        
        <table class="rubric-table">
            <thead>
                <tr>
                    <th>Criterios</th>
`;

            levels.forEach(level => {
                pdfContent += `                    <th>${level.name}<br>(${level.relativeValue} pts)</th>\n`;
            });

            pdfContent += `                </tr>
            </thead>
            <tbody>
`;

            criteria.forEach(criterion => {
                pdfContent += `                <tr>
                    <td class="criterion-cell">${criterion.name}<br>(Máx: ${criterion.maxPoints} pts)</td>\n`;
                
                levels.forEach(level => {
                    const key = `${criterion.id}-${level.id}`;
                    const descriptor = descriptors[key] || "";
                    const calculatedScore = maxOverallLevelValue > 0 ? ((level.relativeValue / maxOverallLevelValue) * criterion.maxPoints).toFixed(1) : 0;
                    
                    pdfContent += `                    <td class="descriptor-cell">
                        ${descriptor}
                        <br>
                        <span class="score-value">(${calculatedScore} pts)</span>
                    </td>\n`;
                });
                
                pdfContent += `                </tr>\n`;
            });

            pdfContent += `            </tbody>
                </table>
                
                <div class="observations">
                    <h3>Observaciones específicas de la evaluación</h3>
                    <textarea id="eval-observations" placeholder="Escriba aquí las observaciones detalladas para el estudiante..." style="width: 100%; min-height: 100px; padding: 10px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
                    <h3>Observaciones generales de la rúbrica</h3>
                    <p>${observations.replace(/\n/g, '<br>')}</p>
                </div>

                <div class="total-score-summary">
                    <p><strong>Puntaje total alcanzado:</strong> <span class="blank-line"></span> / ${totalMaxPossibleScore} pts</p>
                    <p><strong>Puntaje normalizado (sobre 100):</strong> <span class="blank-line"></span></p>
                </div>
                
                <div class="signature">
                    <div>
                        <div class="signature-line">Firma del docente</div>
                    </div>
                    <div>
                        <div class="signature-line">Firma del estudiante</div>
                    </div>
                </div>
            </div>
            
            <script>
                document.getElementById('date').valueAsDate = new Date();
            <\/script>
        </body>
        </html>`;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(pdfContent);
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
        }
        
        // Reiniciar formulario
        function resetForm() {
            if (confirm("¿Está seguro de que desea reiniciar todo el formulario? Se perderán todos los datos ingresados.")) {
                teacherNameInput.value = "";
                subjectInput.value = "";
                workInput.value = "";
                observationsInput.value = "";
                levels = [];
                criteria = [];
                descriptors = {};
                renderLevelsList();
                renderCriteriaList();
                generateTemplate();
            }
        }
        
        // --- Eventos ---
        document.getElementById('add-level').addEventListener('click', () => {
            addLevel(levelNameInput.value, levelValueInput.value);
        });
        
        document.getElementById('add-criterion').addEventListener('click', () => {
            addCriterion(criterionNameInput.value, criterionMaxPointsInput.value);
        });
        
        document.getElementById('generate-btn').addEventListener('click', generateTemplate);
        
        document.getElementById('export-html').addEventListener('click', exportToHTML);
        
        document.getElementById('export-pdf').addEventListener('click', exportToPDF);
        
        document.getElementById('reset-btn').addEventListener('click', resetForm);
        
        // --- Inicializar con datos de ejemplo ---
        window.onload = function() {
            teacherNameInput.value = "María González";
            subjectInput.value = "Lengua y literatura"; // Corregido
            workInput.value = "Ensayo argumentativo";
            observationsInput.value = "Esta rúbrica está diseñada para evaluar ensayos argumentativos. Asegúrese de leer detenidamente cada descriptor antes de asignar un nivel.";
            
            // Add levels with relative values
            addLevel("Excelente", 4);
            addLevel("Bueno", 3);
            addLevel("Regular", 2);
            addLevel("Insuficiente", 1);
            
            // Add criteria with max points (summing to 100 for easy demo)
            addCriterion("Claridad del mensaje", 25);
            addCriterion("Ortografía y gramática", 20);
            addCriterion("Cohesión y coherencia", 20);
            addCriterion("Argumentación y desarrollo de ideas", 20);
            addCriterion("Cumplimiento de requisitos formales", 15); 
            
            // Manually add some example descriptors (for demonstration)
            // Note: These IDs will match the dynamically generated ones if loaded on first run.
            // In a real app, you might save and load descriptors based on actual criterion/level IDs.
            setTimeout(() => { // Add a slight delay to ensure IDs are set after addCriterion
                // Assuming criteria and levels are added in order and their IDs are stable for this example
                const c1 = criteria[0].id; const l1 = levels[0].id; // Claridad - Excelente
                const c2 = criteria[1].id; const l2 = levels[1].id; // Ortografía - Bueno

                if (c1 && l1) descriptors[`${c1}-${l1}`] = "El mensaje es excepcionalmente claro y conciso, con ideas bien desarrolladas y fáciles de seguir.";
                if (c1 && levels[1]) descriptors[`${c1}-${levels[1].id}`] = "El mensaje es claro en su mayoría, con algunas ambigüedades menores que no impiden la comprensión general.";
                if (c1 && levels[2]) descriptors[`${c1}-${levels[2].id}`] = "El mensaje presenta algunas faltas de claridad, lo que dificulta la comprensión en varios puntos.";
                if (c1 && levels[3]) descriptors[`${c1}-${levels[3].id}`] = "El mensaje es confuso y desorganizado, haciendo muy difícil entender las ideas principales.";
                
                if (c2 && l1) descriptors[`${c2}-${l1}`] = "Sin errores de ortografía, gramática o puntuación. El texto es impecable.";
                if (c2 && l2) descriptors[`${c2}-${l2}`] = "Pocos errores de ortografía, gramática o puntuación que no afectan significativamente la comprensión.";
                if (c2 && levels[2]) descriptors[`${c2}-${levels[2].id}`] = "Presenta varios errores de ortografía, gramática o puntuación que dificultan ocasionalmente la lectura.";
                if (c2 && levels[3]) descriptors[`${c2}-${levels[3].id}`] = "Numerosos errores de ortografía, gramática y puntuación que hacen el texto difícil de leer y comprender.";

                generateTemplate(); // Generar la vista previa inicial
            }, 100); // Small delay
        };
    </script>
</body>
</html>
